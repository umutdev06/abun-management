<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ABÜ • Ders Yönetim Sistemi</title>
  <meta name="description" content="Ankara Bilim Üniversitesi • Ders Yönetim Sistemi – Öğretim üyesi ders oluşturur, öğrenciler onay kodu ile katılır, katılımcılar Excel'e aktarılır." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #ffffff;
      --card: #f8fafc;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --accent: #f72585;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --abu-blue: #1e3a8a;
      --abu-gold: #f0c96a;
      --glass: rgba(241, 245, 249, 0.8);
      --glass-2: rgba(226, 232, 240, 0.9);
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 10px 25px rgba(0,0,0,0.12);
      --radius: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji','Segoe UI Emoji', sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.6;
    }

    header{
      position: sticky; top:0; z-index: 50; backdrop-filter: blur(12px);
      background: rgba(255,255,255,0.9);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .container{ max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:16px; padding:16px 0;
    }

    .brand{ display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit; }
    .brand-logo{
      width: 120px;
      height: 120px;
      border-radius: 8px;
      object-fit: contain;
    }
    .brand-text{ display:flex; flex-direction:column; }
    .brand-title{ font-weight:800; letter-spacing:.3px; color: var(--primary-dark); }
    .brand-sub{ font-size:12px; color: var(--muted) }

    .nav-actions{ display:flex; gap:10px; align-items:center; }

    .btn{
      --bg: var(--glass);
      --fg: var(--text);
      cursor:pointer; border:none; outline:none; color: var(--fg);
      background: var(--bg); padding: 10px 16px; border-radius: 10px;
      font-weight:600; letter-spacing:.2px; transition:.2s ease transform, .2s ease background, .2s ease box-shadow;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .btn:hover{ transform: translateY(-2px); background: var(--glass-2); box-shadow: var(--shadow-hover); }
    .btn:active{ transform: translateY(0); }

    .btn-primary{ 
      background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
      color: white; 
      border: none; 
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .btn-primary:hover{ 
      background: linear-gradient(135deg, var(--primary-light), var(--primary-dark)); 
      filter: brightness(1.05); 
    }

    .btn-danger{ background: linear-gradient(135deg, #ef4444, #dc2626); color:white; border:none; }
    .btn-success{ background: linear-gradient(135deg, #22c55e, #16a34a); color:white; border:none; }
    .btn-outline{ background: transparent; border:1px solid rgba(0,0,0,0.15) }

    .hero{
      position: relative; padding: 50px 0 30px; overflow: hidden;
      background: transparent;
      margin-bottom: 30px;
    }
    .headline{ 
      font-size: clamp(26px, 4vw, 40px); 
      font-weight: 800; 
      line-height: 1.2; 
      margin: 20px 0;
      text-align: center;
    }
    .tag{ 
      display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:999px; 
      background: rgba(37, 99, 235, 0.1); 
      border:1px solid rgba(37, 99, 235, 0.2); 
      color: var(--primary-dark); 
      font-weight:600; font-size:13px; letter-spacing:.3px;
      margin: 0 auto;
      display: table;
    }
    .tag svg{ width:16px; height:16px }

    .grid{ display:grid; gap:18px; grid-template-columns: repeat(12, 1fr); }

    .card{
      background: var(--card); border:1px solid rgba(0,0,0,0.08); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 20px; transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      position: relative; overflow: hidden;
    }
    .card:hover{ transform: translateY(-4px); border-color: rgba(0,0,0,0.12); box-shadow: var(--shadow-hover) }

    .section-title{ font-size: 22px; font-weight: 800; margin: 6px 0 14px; letter-spacing:.2px; color: var(--primary-dark); }
    .muted{ color: var(--muted); font-size:14px }

    /* Courses */
    #coursesContainer{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px }
    .course-card{ border-left: 4px solid var(--primary); }
    .course-title{ font-weight:800; font-size:18px; margin-bottom:6px; color: var(--primary-dark); }
    .course-meta{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 12px }
    .badge{ 
      font-size:12px; padding:6px 10px; border-radius:999px; 
      background: rgba(37, 99, 235, 0.08); 
      border:1px solid rgba(37, 99, 235, 0.15); 
      color: var(--primary-dark) 
    }
    .badge-classroom {
      background: rgba(34, 197, 94, 0.08); 
      border:1px solid rgba(34, 197, 94, 0.15); 
      color: #16a34a;
    }

    .empty{
      text-align:center; padding:26px; border:1px dashed rgba(0,0,0,0.15); color:var(--muted); border-radius:16px;
    }

    /* Admin panel */
    #adminPanel{ margin-top:20px }
    .admin-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:16px }

    /* Forms */
    .form-group{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px }
    label{ font-weight:700; font-size:14px }
    .input, textarea, select{
      width:100%; background: white; border:1px solid rgba(0,0,0,0.12); color: var(--text);
      border-radius: 10px; padding: 12px 14px; outline:none; transition: .2s ease border, .2s ease box-shadow;
    }
    .input:focus, textarea:focus, select:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15) }
    textarea{ resize: vertical; min-height: 90px }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; padding:20px; z-index:1000; }
    .modal.open{ display:grid; animation: fadeIn .2s ease }
    .modal::before{ content:""; position:absolute; inset:0; background: rgba(0,0,0,.4); backdrop-filter: blur(6px); }
    .modal-content{ 
      position:relative; width:min(620px, 96vw); 
      background: white; 
      border:1px solid rgba(0,0,0,0.1); 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
      transform-origin: 50% 40%; 
      animation: pop .2s ease 
    }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
    @keyframes pop{ from{ transform: scale(.96); opacity:.6 } to{ transform: scale(1); opacity:1 } }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:16px }
    .modal-title{ font-size:20px; font-weight:800; color: var(--primary-dark) }

    /* Toast */
    .toast{ position: fixed; right:16px; bottom:16px; display:grid; gap:10px; z-index:1100 }
    .toast-item{ 
      background: rgba(13,201,175,.12); 
      color:#0f766e; 
      border:1px solid rgba(13,201,175,.35); 
      padding:12px 14px; 
      border-radius:10px; 
      box-shadow: var(--shadow); 
      animation: slideIn .25s ease 
    }
    @keyframes slideIn{ from{ transform: translateY(8px); opacity:0 } to{ transform: translateY(0); opacity:1 } }

    /* Footer */
    footer{ 
      opacity:.85; 
      border-top:1px solid rgba(0,0,0,0.08); 
      margin-top: 40px; 
      background: #f8fafc;
    }
    .footer-inner{ padding:18px 0; display:flex; justify-content:center; font-size:13px; color:var(--muted) }

    /* Responsive */
    @media (max-width:780px){
      .nav{ flex-wrap: wrap }
      .brand-sub{ display:none }
      .hero { padding: 30px 0 20px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="#" aria-label="Ankara Bilim Üniversitesi Ders Yönetim Sistemi">
        <img src="logo.png" alt="Ankara Bilim Üniversitesi" class="brand-logo">
        <div class="brand-text">
          <div class="brand-title">Ders Yönetim Sistemi</div>
          <div class="brand-sub">Ankara Bilim Üniversitesi</div>
        </div>
      </a>
      <div class="nav-actions">
        <button class="btn btn-primary" id="loginBtn">Öğretim Üyesi Girişi</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="tag"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l2.4 4.86 5.37.78-3.88 3.78.92 5.36L12 15.9 7.19 17.78l.92-5.36L4.23 8.64l5.37-.78L12 3z" stroke="currentColor" stroke-width="1.4"/></svg> Yoklama & Katılım • Ankara Bilim Üniversitesi</div>
      <h1 class="headline">Dersi oluştur, öğrencileri katılmaya davet et, <span style="background:linear-gradient(135deg,var(--primary),var(--primary-light)); -webkit-background-clip:text; background-clip:text; color:transparent">Excel'e tek tıkla aktar</span>.</h1>
    </section>

    <section class="card" aria-labelledby="aktif-dersler">
      <div class="section-title" id="aktif-dersler">Aktif Dersler</div>
      <p class="muted" style="margin-bottom:12px">Aşağıdan katılmak istediğiniz dersi seçin, bilgilerinizi girin ve derse kayıt olun!</p>
      <div id="coursesContainer"></div>
      <div id="noCoursesMessage" class="empty" style="display:none">Şu anda katılabileceğin aktif bir ders bulunmuyor.</div>
    </section>

    <section id="adminPanel" class="card" style="display:none" aria-live="polite">
      <div class="section-title">Öğretim Üyesi Paneli</div>
      <p class="muted">Hoş geldiniz, <strong id="instructorName">-</strong>. Ders oluşturabilir, katılımcıları görüntüleyebilir ve Excel olarak indirebilirsiniz.</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn btn-primary" id="createCourseBtn">Yeni Ders Oluştur</button>
        <button class="btn btn-danger" id="clearAllDataBtn">Tüm Verileri Temizle</button>
      </div>

      <div style="margin-top:16px; display:flex; align-items:center; gap:10px">
        <input id="adminSearch" class="input" placeholder="Derslerde ara (ad, açıklama, sınıf)" />
        <button class="btn" id="adminSearchClear">Temizle</button>
      </div>

      <div id="adminCoursesList" class="admin-grid" style="margin-top:14px"></div>
    </section>
  </main>

  <!-- Login Modal -->
  <div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="loginTitle">Öğretim Üyesi Girişi</div>
        <button class="btn" id="cancelLoginBtn" aria-label="Kapat">✕</button>
      </div>
      <div class="form-group">
        <label for="username">Kullanıcı Adı</label>
        <input id="username" class="input" placeholder="Kullanıcı Adı" />
      </div>
      <div class="form-group">
        <label for="password">Şifre</label>
        <input id="password" type="password" class="input" placeholder="Şifre" />
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px">
        <button class="btn" id="confirmLoginBtn">Giriş Yap</button>
      </div>
    </div>
  </div>

  <!-- Create Course Modal -->
  <div class="modal" id="createCourseModal" role="dialog" aria-modal="true" aria-labelledby="createTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="createTitle">Yeni Ders Oluştur</div>
        <button class="btn" id="cancelCreateCourseBtn" aria-label="Kapat">✕</button>
      </div>
      <div class="form-group">
        <label for="courseName">Ders Adı</label>
        <input id="courseName" class="input" placeholder="Örn: Bilgi Sistemleri 101" />
      </div>
      <div class="form-group">
        <label for="courseDescription">Ders Açıklaması</label>
        <textarea id="courseDescription" placeholder="Örn: Giriş düzeyi bilgi sistemleri dersi"></textarea>
      </div>
      <div class="form-group">
        <label for="courseClassroom">Sınıf</label>
        <select id="courseClassroom" class="input">
          <option value="">Sınıf seçiniz</option>
          <option value="AMFI 1">AMFI 1</option>
          <option value="AMFI 2">AMFI 2</option>
          <option value="AMFI 3">AMFI 3</option>
          <option value="AMFI 4">AMFI 4</option>
          <option value="LH 1">LH 1</option>
          <option value="LH 2">LH 2</option>
          <option value="LH 3">LH 3</option>
          <option value="LH 4">LH 4</option>
          <option value="LH 5">LH 5</option>
          <option value="LH 6">LH 6</option>
          <option value="LH 7">LH 7</option>
          <option value="C-100">C-100</option>
          <option value="C-101">C-101</option>
          <option value="C-102">C-102</option>
          <option value="C-103">C-103</option>
          <option value="Konferans Salonu">Konferans Salonu</option>
          <option value="Laboratuvar-1">Laboratuvar-1</option>
          <option value="Laboratuvar-2">Laboratuvar-2</option>
          <option value="Uzaktan Eğitim">Uzaktan Eğitim</option>
        </select>
      </div>
      <div class="muted" style="background:rgba(37, 99, 235, 0.08); border:1px solid rgba(37, 99, 235, 0.2); padding:12px 14px; border-radius:10px">Ders oluşturulduğunda sistem otomatik <strong>5 haneli onay kodu</strong> üretir. Bu kodu öğrencilerle paylaşın.</div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px">
        <button class="btn btn-primary" id="confirmCreateCourseBtn">Oluştur</button>
      </div>
    </div>
  </div>

  <!-- Delete Course Modal -->
  <div class="modal" id="deleteCourseModal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="deleteTitle">Dersi Sil</div>
        <button class="btn" id="cancelDeleteCourseBtn" aria-label="Kapat">✕</button>
      </div>
      <div class="muted" style="background: rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.2); padding:12px 14px; border-radius:10px; margin-bottom:10px"><strong>Uyarı:</strong> Bu işlem geri alınamaz. Dersi ve tüm katılımcıları sileceksiniz.</div>
      <p id="deleteCourseMessage" style="margin: 0 0 10px"></p>
      <div style="display:flex; justify-content:flex-end; gap:10px">
        <button class="btn btn-danger" id="confirmDeleteCourseBtn">Dersi Sil</button>
      </div>
    </div>
  </div>

  <!-- Clear All Data Modal -->
  <div class="modal" id="clearAllDataModal" role="dialog" aria-modal="true" aria-labelledby="clearAllTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="clearAllTitle">Tüm Verileri Temizle</div>
        <button class="btn" id="cancelClearAllDataBtn" aria-label="Kapat">✕</button>
      </div>
      <div class="muted" style="background: rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.2); padding:12px 14px; border-radius:10px; margin-bottom:10px"><strong>Çok Önemli:</strong> Bu işlem tüm dersleri ve katılımcıları kalıcı olarak siler.</div>
      <p>Tüm veritabanını sıfırlamak istediğinizden emin misiniz?</p>
      <div style="display:flex; justify-content:flex-end; gap:10px">
        <button class="btn btn-danger" id="confirmClearAllDataBtn">Tümünü Sil</button>
      </div>
    </div>
  </div>

  <!-- Join Course Modal -->
  <div class="modal" id="joinCourseModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="joinTitle">Derse Katıl</div>
        <button class="btn" id="cancelJoinCourseBtn" aria-label="Kapat">✕</button>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
        <div class="form-group"><label for="studentNumber">Öğrenci No</label><input id="studentNumber" class="input" placeholder="Örn: 250307018"></div>
        <div class="form-group"><label for="confirmationCode">Onay Kodu</label><input id="confirmationCode" class="input" placeholder="5 haneli kod"></div>
        <div class="form-group" style="grid-column: span 1"><label for="studentName">Ad</label><input id="studentName" class="input" placeholder="Adınız"></div>
        <div class="form-group" style="grid-column: span 1"><label for="studentSurname">Soyad</label><input id="studentSurname" class="input" placeholder="Soyadınız"></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px">
        <button class="btn btn-primary" id="confirmJoinCourseBtn">Katıl</button>
      </div>
    </div>
  </div>

  <!-- View Participants Modal -->
  <div class="modal" id="viewParticipantsModal" role="dialog" aria-modal="true" aria-labelledby="participantsTitle">
    <div class="modal-content" style="width:min(860px, 96vw)">
      <div class="modal-header">
        <div class="modal-title" id="participantsTitle">Katılımcılar</div>
        <button class="btn" id="closeParticipantsBtn" aria-label="Kapat">✕</button>
      </div>
      <div id="participantsList" class="card" style="background:transparent; box-shadow:none; padding:0; border:none">
        <!-- List -->
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px">
        <button class="btn btn-success" id="exportParticipantsBtn">Excel'e Aktar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <footer>
    <div class="container footer-inner">© 2025 Ankara Bilim Üniversitesi — developed by Umut Can Kandemir</div>
  </footer>

  <script>
    // ------------------ Constants & State ------------------
    const DB_NAME = 'DersYonetimDB';
    const DB_VERSION = 1;
    const COURSES_STORE = 'courses';
    const PARTICIPANTS_STORE = 'participants';

    // Yeni admin hesapları ve şifreleri
    const ADMIN_ACCOUNTS = {
      'admin': { password: '12345', name: 'Prof. Dr. Cem Harun Meydan' },
      'admin1': { password: '73928', name: 'Prof. Dr. Neslihan Künye Polat' },
      'admin2': { password: '48516', name: 'Prof. Dr. Mehmet Alper Akdemir' },
      'admin3': { password: '62047', name: 'Prof. Dr. Güney Gürsel' },
      'admin4': { password: '19375', name: 'Prof. Dr. Adil Akkuş' }
    };

    let db = null;
    let courses = [];
    let currentUser = null;
    let selectedCourseId = null;
    let courseToDeleteId = null;

    // ------------------ Elements ------------------
    const coursesContainer = document.getElementById('coursesContainer');
    const noCoursesMessage = document.getElementById('noCoursesMessage');
    const adminPanel = document.getElementById('adminPanel');
    const adminCoursesList = document.getElementById('adminCoursesList');
    const instructorNameEl = document.getElementById('instructorName');
    const adminSearch = document.getElementById('adminSearch');
    const adminSearchClear = document.getElementById('adminSearchClear');
    const toastRoot = document.getElementById('toast');

    // Modals
    const loginModal = document.getElementById('loginModal');
    const createCourseModal = document.getElementById('createCourseModal');
    const deleteCourseModal = document.getElementById('deleteCourseModal');
    const clearAllDataModal = document.getElementById('clearAllDataModal');
    const joinCourseModal = document.getElementById('joinCourseModal');
    const viewParticipantsModal = document.getElementById('viewParticipantsModal');

    // Buttons
    const loginBtn = document.getElementById('loginBtn');
    const cancelLoginBtn = document.getElementById('cancelLoginBtn');
    const confirmLoginBtn = document.getElementById('confirmLoginBtn');
    const createCourseBtn = document.getElementById('createCourseBtn');
    const cancelCreateCourseBtn = document.getElementById('cancelCreateCourseBtn');
    const confirmCreateCourseBtn = document.getElementById('confirmCreateCourseBtn');
    const cancelDeleteCourseBtn = document.getElementById('cancelDeleteCourseBtn');
    const confirmDeleteCourseBtn = document.getElementById('confirmDeleteCourseBtn');
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');
    const cancelClearAllDataBtn = document.getElementById('cancelClearAllDataBtn');
    const confirmClearAllDataBtn = document.getElementById('confirmClearAllDataBtn');
    const cancelJoinCourseBtn = document.getElementById('cancelJoinCourseBtn');
    const confirmJoinCourseBtn = document.getElementById('confirmJoinCourseBtn');
    const closeParticipantsBtn = document.getElementById('closeParticipantsBtn');
    const exportParticipantsBtn = document.getElementById('exportParticipantsBtn');

    document.addEventListener('DOMContentLoaded', () => {
      initDatabase();
      // Listeners
      loginBtn.addEventListener('click', () => openModal(loginModal));
      cancelLoginBtn.addEventListener('click', () => closeModal(loginModal));
      confirmLoginBtn.addEventListener('click', handleLogin);

      createCourseBtn?.addEventListener('click', () => openModal(createCourseModal));
      cancelCreateCourseBtn?.addEventListener('click', () => closeModal(createCourseModal));
      confirmCreateCourseBtn?.addEventListener('click', handleCreateCourse);

      cancelDeleteCourseBtn?.addEventListener('click', () => closeModal(deleteCourseModal));
      confirmDeleteCourseBtn?.addEventListener('click', handleDeleteCourse);

      clearAllDataBtn?.addEventListener('click', () => openModal(clearAllDataModal));
      cancelClearAllDataBtn?.addEventListener('click', () => closeModal(clearAllDataModal));
      confirmClearAllDataBtn?.addEventListener('click', handleClearAllData);

      cancelJoinCourseBtn?.addEventListener('click', () => closeModal(joinCourseModal));
      confirmJoinCourseBtn?.addEventListener('click', handleJoinCourse);

      closeParticipantsBtn?.addEventListener('click', () => closeModal(viewParticipantsModal));
      exportParticipantsBtn?.addEventListener('click', handleExportParticipants);

      adminSearch.addEventListener('input', renderAdminCourses);
      adminSearchClear.addEventListener('click', () => { adminSearch.value = ''; renderAdminCourses(); });

      // Close modal on backdrop
      document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('click', (e) => { if (e.target === m) closeModal(m); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(m); });
      })
    });

    // ------------------ IndexedDB ------------------
    function initDatabase(){
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = (e) => { notify('Veritabanı bağlantı hatası!', 'error'); };
      request.onsuccess = (e) => { db = e.target.result; loadCoursesFromDB(); };
      request.onupgradeneeded = (e) => {
        const database = e.target.result;
        if(!database.objectStoreNames.contains(COURSES_STORE)){
          const cs = database.createObjectStore(COURSES_STORE, { keyPath:'id', autoIncrement:true });
          cs.createIndex('instructor', 'instructor', { unique:false });
        }
        if(!database.objectStoreNames.contains(PARTICIPANTS_STORE)){
          const ps = database.createObjectStore(PARTICIPANTS_STORE, { keyPath:'id', autoIncrement:true });
          ps.createIndex('courseId', 'courseId', { unique:false });
          ps.createIndex('studentNumber', 'studentNumber', { unique:false });
        }
      }
    }

    function tx(storeNames, mode='readonly'){ return db.transaction(storeNames, mode); }

    function loadCoursesFromDB(){
      if(!db) return;
      const req = tx([COURSES_STORE]).objectStore(COURSES_STORE).getAll();
      req.onsuccess = (e) => {
        courses = e.target.result || [];
        // Attach participants to each course
        courses.forEach(c => loadParticipantsForCourse(c.id));
        renderCourses();
      };
    }

    function loadParticipantsForCourse(courseId){
      const store = tx([PARTICIPANTS_STORE]).objectStore(PARTICIPANTS_STORE);
      const idx = store.index('courseId');
      const req = idx.getAll(courseId);
      req.onsuccess = (e) => {
        const p = e.target.result || [];
        const course = courses.find(c => c.id === courseId);
        if(course) course.participants = p;
      }
    }

    // ------------------ Render ------------------
    function renderCourses(){
      coursesContainer.innerHTML = '';
      if(!courses.length){ noCoursesMessage.style.display = 'block'; } else { noCoursesMessage.style.display = 'none'; }

      courses.forEach(course => {
        const el = document.createElement('div');
        el.className = 'card course-card';
        const showCode = currentUser && course.instructor === currentUser.name;
        el.innerHTML = `
          <div class="course-title">${escapeHtml(course.name)}</div>
          <div class="muted" style="margin-bottom:10px">${escapeHtml(course.description || '')}</div>
          <div class="course-meta">
            <span class="badge">Eğitmen: ${escapeHtml(course.instructor)}</span>
            <span class="badge">Katılımcı: ${course.participants ? course.participants.length : 0}</span>
            ${course.classroom ? `<span class="badge badge-classroom">Sınıf: ${escapeHtml(course.classroom)}</span>` : ''}
            ${showCode ? `<span class="badge">Onay Kodu: <strong>${course.code}</strong></span>` : ''}
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn btn-primary join-course-btn" data-id="${course.id}">Derse Katıl</button>
            ${currentUser && course.instructor === currentUser.name ? `
              <button class="btn view-participants-btn" data-id="${course.id}">Katılımcıları Gör</button>
              <button class="btn btn-success export-course-btn" data-id="${course.id}">Excel</button>
              <button class="btn btn-danger delete-course-btn" data-id="${course.id}" data-name="${encodeURIComponent(course.name)}">Sil</button>
            `: ''}
          </div>
        `;
        coursesContainer.appendChild(el);
      });

      // attach events
      document.querySelectorAll('.join-course-btn').forEach(b => b.addEventListener('click', () => {
        selectedCourseId = parseInt(b.getAttribute('data-id')); openModal(joinCourseModal);
      }));
      document.querySelectorAll('.view-participants-btn').forEach(b => b.addEventListener('click', () => {
        selectedCourseId = parseInt(b.getAttribute('data-id')); openViewParticipantsModal();
      }));
      document.querySelectorAll('.export-course-btn').forEach(b => b.addEventListener('click', () => {
        selectedCourseId = parseInt(b.getAttribute('data-id')); handleExportParticipants();
      }));
      document.querySelectorAll('.delete-course-btn').forEach(b => b.addEventListener('click', () => {
        courseToDeleteId = parseInt(b.getAttribute('data-id'));
        const name = decodeURIComponent(b.getAttribute('data-name'));
        document.getElementById('deleteCourseMessage').textContent = `"${name}" dersini silmek istediğinizden emin misiniz?`;
        openModal(deleteCourseModal);
      }));

      if(currentUser) renderAdminCourses();
    }

    function renderAdminCourses(){
      const term = (adminSearch.value || '').toLowerCase();
      const list = courses.filter(c => currentUser && c.instructor === currentUser.name)
                          .filter(c => !term || 
                            (c.name?.toLowerCase().includes(term) || 
                             (c.description||'').toLowerCase().includes(term) ||
                             (c.classroom||'').toLowerCase().includes(term)));
      adminCoursesList.innerHTML = '';
      if(!list.length){
        adminCoursesList.innerHTML = '<div class="empty">Bu kriterle eşleşen ders bulunamadı.</div>';
        return;
      }
      list.forEach(course => {
        const item = document.createElement('div');
        item.className = 'card';
        item.innerHTML = `
          <div class="course-title">${escapeHtml(course.name)}</div>
          <div class="muted">${escapeHtml(course.description || '')}</div>
          <div class="course-meta" style="margin-top:10px">
            ${course.classroom ? `<span class="badge badge-classroom">Sınıf: ${escapeHtml(course.classroom)}</span>` : ''}
            <span class="badge">Onay Kodu: <strong>${course.code}</strong></span>
            <span class="badge">Katılımcı: ${course.participants ? course.participants.length : 0}</span>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn view-participants-btn" data-id="${course.id}">Katılımcıları Gör</button>
            <button class="btn btn-success export-course-btn" data-id="${course.id}">Excel</button>
            <button class="btn btn-danger delete-course-btn" data-id="${course.id}" data-name="${encodeURIComponent(course.name)}">Dersi Sil</button>
          </div>
        `;
        adminCoursesList.appendChild(item);
      });

      // Re-bind
      adminPanel.querySelectorAll('.view-participants-btn').forEach(b => b.addEventListener('click', () => { selectedCourseId = parseInt(b.getAttribute('data-id')); openViewParticipantsModal(); }));
      adminPanel.querySelectorAll('.export-course-btn').forEach(b => b.addEventListener('click', () => { selectedCourseId = parseInt(b.getAttribute('data-id')); handleExportParticipants(); }));
      adminPanel.querySelectorAll('.delete-course-btn').forEach(b => b.addEventListener('click', () => {
        courseToDeleteId = parseInt(b.getAttribute('data-id'));
        const name = decodeURIComponent(b.getAttribute('data-name'));
        document.getElementById('deleteCourseMessage').textContent = `"${name}" dersini silmek istediğinizden emin misiniz?`;
        openModal(deleteCourseModal);
      }));
    }

    // ------------------ Modal ------------------
    function openModal(modal){ modal.classList.add('open'); }
    function closeModal(modal){ modal.classList.remove('open'); }

    function openViewParticipantsModal(){
      const course = courses.find(c => c.id === selectedCourseId);
      if(!course) return;
      document.getElementById('participantsTitle').textContent = `${course.name} - Katılımcılar ${course.classroom ? `(${course.classroom})` : ''}`;
      const listEl = document.getElementById('participantsList');
      listEl.innerHTML = '';
      if(!course.participants || !course.participants.length){
        listEl.innerHTML = '<div class="empty">Bu derse henüz katılımcı yok.</div>';
      } else {
        const table = document.createElement('table');
        table.style.width = '100%'; table.style.borderCollapse = 'collapse';
        table.innerHTML = `
          <thead>
            <tr style="border-bottom:1px solid rgba(0,0,0,0.1)">
              <th style="text-align:left; padding:8px 12px">Öğrenci No</th>
              <th style="text-align:left; padding:8px 12px">Ad</th>
              <th style="text-align:left; padding:8px 12px">Soyad</th>
              <th style="text-align:left; padding:8px 12px">Katılma Tarihi</th>
            </tr>
          </thead>
          <tbody>
            ${course.participants.map(p => `
              <tr style="border-bottom:1px solid rgba(0,0,0,0.05)">
                <td style="padding:8px 12px">${escapeHtml(p.studentNumber)}</td>
                <td style="padding:8px 12px">${escapeHtml(p.name)}</td>
                <td style="padding:8px 12px">${escapeHtml(p.surname)}</td>
                <td style="padding:8px 12px">${new Date(p.joinDate).toLocaleString('tr-TR')}</td>
              </tr>
            `).join('')}
          </tbody>
        `;
        listEl.appendChild(table);
      }
      openModal(viewParticipantsModal);
    }

    // ------------------ Handlers ------------------
    function handleLogin(){
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if(!username || !password){ notify('Lütfen kullanıcı adı ve şifre girin!', 'warning'); return; }
      if(ADMIN_ACCOUNTS[username] && ADMIN_ACCOUNTS[username].password === password){
        currentUser = { name: ADMIN_ACCOUNTS[username].name };
        instructorNameEl.textContent = currentUser.name;
        adminPanel.style.display = 'block';
        closeModal(loginModal);
        notify(`Hoş geldiniz, ${currentUser.name}!`, 'success');
        renderCourses();
      } else {
        notify('Kullanıcı adı veya şifre hatalı!', 'error');
      }
    }

    function handleCreateCourse(){
      const name = document.getElementById('courseName').value.trim();
      const description = document.getElementById('courseDescription').value.trim();
      const classroom = document.getElementById('courseClassroom').value;
      if(!name){ notify('Ders adı gerekli!', 'warning'); return; }
      if(!classroom){ notify('Lütfen sınıf seçiniz!', 'warning'); return; }
      const code = generateCode();
      const course = {
        name, description, classroom, code, instructor: currentUser.name,
        createdDate: new Date().toISOString()
      };
      const store = tx([COURSES_STORE], 'readwrite').objectStore(COURSES_STORE);
      const req = store.add(course);
      req.onsuccess = () => {
        notify(`"${name}" dersi oluşturuldu! Onay kodu: ${code}`, 'success');
        closeModal(createCourseModal);
        document.getElementById('courseName').value = '';
        document.getElementById('courseDescription').value = '';
        document.getElementById('courseClassroom').value = '';
        loadCoursesFromDB();
      };
    }

    function handleDeleteCourse(){
      if(!courseToDeleteId) return;
      const store = tx([COURSES_STORE], 'readwrite').objectStore(COURSES_STORE);
      const req = store.delete(courseToDeleteId);
      req.onsuccess = () => {
        // Delete participants
        const pStore = tx([PARTICIPANTS_STORE], 'readwrite').objectStore(PARTICIPANTS_STORE);
        const idx = pStore.index('courseId');
        const req2 = idx.openCursor(courseToDeleteId);
        req2.onsuccess = (e) => {
          const cursor = e.target.result;
          if(cursor){ cursor.delete(); cursor.continue(); }
        };
        notify('Ders silindi!', 'success');
        closeModal(deleteCourseModal);
        loadCoursesFromDB();
      };
    }

    function handleClearAllData(){
      const store = tx([COURSES_STORE], 'readwrite').objectStore(COURSES_STORE);
      const req = store.clear();
      req.onsuccess = () => {
        const pStore = tx([PARTICIPANTS_STORE], 'readwrite').objectStore(PARTICIPANTS_STORE);
        const req2 = pStore.clear();
        req2.onsuccess = () => {
          notify('Tüm veriler silindi!', 'success');
          closeModal(clearAllDataModal);
          loadCoursesFromDB();
        };
      };
    }

    function handleJoinCourse(){
      const studentNumber = document.getElementById('studentNumber').value.trim();
      const code = document.getElementById('confirmationCode').value.trim();
      const name = document.getElementById('studentName').value.trim();
      const surname = document.getElementById('studentSurname').value.trim();
      if(!studentNumber || !code || !name || !surname){ notify('Lütfen tüm alanları doldurun!', 'warning'); return; }
      const course = courses.find(c => c.code === code);
      if(!course){ notify('Geçersiz onay kodu!', 'error'); return; }
      // Check if already joined
      const store = tx([PARTICIPANTS_STORE]).objectStore(PARTICIPANTS_STORE);
      const idx = store.index('studentNumber');
      const req = idx.get(studentNumber);
      req.onsuccess = (e) => {
        if(e.target.result){ notify('Bu öğrenci numarası zaten kayıtlı!', 'warning'); return; }
        // Add participant
        const pStore = tx([PARTICIPANTS_STORE], 'readwrite').objectStore(PARTICIPANTS_STORE);
        const participant = { courseId: course.id, studentNumber, name, surname, joinDate: new Date().toISOString() };
        const req2 = pStore.add(participant);
        req2.onsuccess = () => {
          notify(`"${course.name}" dersine başarıyla katıldınız!`, 'success');
          closeModal(joinCourseModal);
          document.getElementById('studentNumber').value = '';
          document.getElementById('confirmationCode').value = '';
          document.getElementById('studentName').value = '';
          document.getElementById('studentSurname').value = '';
          loadCoursesFromDB();
        };
      };
    }

    function handleExportParticipants(){
      const course = courses.find(c => c.id === selectedCourseId);
      if(!course) return;
      if(!course.participants || !course.participants.length){ notify('Katılımcı bulunmuyor!', 'warning'); return; }
      const data = course.participants.map(p => ({
        'Öğrenci No': p.studentNumber, 'Ad': p.name, 'Soyad': p.surname,
        'Katılma Tarihi': new Date(p.joinDate).toLocaleString('tr-TR')
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Katılımcılar');
      XLSX.writeFile(wb, `${course.name.replace(/[^a-zA-Z0-9]/g, '_')}_katilimci_listesi.xlsx`);
      notify('Excel dosyası indiriliyor...', 'success');
    }

    // ------------------ Utils ------------------
    function generateCode(){ return Math.random().toString(36).substring(2, 7).toUpperCase(); }
    function escapeHtml(unsafe){ return unsafe?.replace(/[&<"'>]/g, m => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m]) || ''; }
    function notify(message, type='info'){
      const item = document.createElement('div');
      item.className = `toast-item ${type}`;
      item.textContent = message;
      toastRoot.appendChild(item);
      setTimeout(() => { if(item.parentNode) item.parentNode.removeChild(item); }, 4000);
    }
  </script>
</body>
</html>
